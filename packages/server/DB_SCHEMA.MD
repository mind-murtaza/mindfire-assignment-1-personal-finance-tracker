# ðŸ“„ Users Collection Schema

## Purpose
Stores user identity, credentials, and application settings.

## Indexes
- `{ email: 1 }` (unique, background)
- `{ status: 1 }` (background)
- `{ status: 1, lastLoginAt: -1 }` (compound, background)

## Schema Definition
```javascript
const UserSchema = {
  _id: ObjectId, // MongoDB ObjectId
  email: String, // Indexed, Unique, Required, Lowercased
  password: String, // Hashed, Required, Not selected by default

  profile: {
    firstName: String, // Required, Only letters
    lastName: String, // Required, Only letters
    avatarUrl: String, // Optional, URL to user's avatar image
    mobileNumber: String, // Optional, 10-digit format
  },

  settings: {
    mobileDialCode: String, // Default: '+91', Validated against known dial codes
    currency: String, // Default: 'INR', ISO 4217 currency codes
    theme: String, // Default: 'system', Enum: ['system', 'light', 'dark']
  },

  status: String, // Required, Enum: ['active', 'suspended', 'pending_verification', 'deleted']

  lastLoginAt: Date, // Nullable, Tracks last login time
  createdAt: Date, // Auto-generated by Mongoose
  updatedAt: Date, // Auto-generated by Mongoose
};
```

## Validation Rules
- **Email**: Must be a valid email format, lowercased, and unique.
- **Password**: Must be at least 8 characters, include uppercase, lowercase, number, and special character.
- **First Name & Last Name**: Only letters, max 50 characters.
- **Mobile Number**: 10-digit format.
- **Mobile Dial Code**: Must be a valid dial code.
- **Currency**: Must be a valid ISO 4217 code.
- **Theme**: Must be one of 'system', 'light', or 'dark'.
- **Status**: Must be one of 'active', 'suspended', 'pending_verification', or 'deleted'.

## Security & Performance
- Passwords are hashed using bcrypt before saving.
- Sensitive fields like password are not selected by default in queries.
- Indexes are created in the background to avoid blocking operations.
- Compound indexes optimize common query patterns for performance.


# ðŸ“„ Categories Collection Schema

## Purpose
Stores user-defined and default categories for transactions.

## Indexes
- `{ userId: 1, type: 1 }` (background)
- `{ userId: 1, isDeleted: 1 }` (background)
- `{ userId: 1, type: 1, isDefault: 1 }` (unique, background, partialFilterExpression: { isDefault: true })

## Schema Definition
```javascript
const CategorySchema = {
  _id: ObjectId, // MongoDB ObjectId
  userId: { type: ObjectId, ref: 'User', required: true, index: true },
  name: { type: String, required: true, trim: true },

  type: {
    type: String,
    enum: ['income', 'expense'],
    required: true
  },

  parentId: { type: ObjectId, ref: 'Category', default: null }, // For sub-categories
  color: { type: String, default: '#CCCCCC' }, // Hex color for UI
  icon: { type: String, default: 'tag' }, // Icon identifier (e.g., from lucide-react)

  isDefault: { type: Boolean, default: false }, // System-provided categories
  monthlyBudget: { type: mongoose.Schema.Types.Decimal128, default: 0.00 },

  // Soft delete fields
  isDeleted: { type: Boolean, default: false, index: true },
  deletedAt: { type: Date, default: null },

  createdAt: Date, // Auto-generated by Mongoose
  updatedAt: Date, // Auto-generated by Mongoose
};
```

## Validation Rules
- **Name**: Required, trimmed, max 50 characters.
- **Type**: Must be one of 'income' or 'expense'.
- **Color**: Must be a valid hex color code.
- **Icon**: Must be lowercase letters and hyphens only, max 30 characters.
- **Monthly Budget**: Must be a positive number with at most 2 decimal places.

## Business Logic
- **Default Category**: Only one default category per user and type (income/expense) is allowed, enforced by a unique index.
- **Parent-Child Relationship**: Categories can have sub-categories, but cannot be their own parent or create circular references.
- **Soft Delete**: Categories can be soft-deleted, retaining their data but marked as inactive.

## Security & Performance
- **Indexes**: Ensure fast queries and enforce unique constraints.
- **Atomic Operations**: Default category logic uses MongoDB transactions for consistency.
- **Zod Validation**: All field-level validation is handled by Zod schemas in the pre-save hook.


# ðŸ“„ Transactions Collection Schema

## Purpose
The core collection storing all individual financial events with optimized performance for reporting and analytics.

## Indexes
- `{ userId: 1, transactionDate: -1 }` (Primary query for transaction lists)
- `{ userId: 1, yearMonth: 1 }` (Monthly reports optimization)
- `{ userId: 1, categoryId: 1 }` (Category-based filtering)
- `{ userId: 1, type: 1, transactionDate: -1 }` (Type-filtered lists)
- `{ userId: 1, year: 1, month: 1 }` (Date-based reports)
- `{ userId: 1, tags: 1 }` (Tag-based searches)
- `{ userId: 1, isDeleted: 1, transactionDate: -1 }` (Soft delete optimization)
- `{ userId: 1, amount: 1 }` (Amount-based filtering)
- `{ userId: 1, type: 1, yearMonth: 1 }` (Complex reporting queries)
- `{ userId: 1, categoryId: 1, transactionDate: -1 }` (Category timeline queries)
- `{ tags: 1 }` (sparse, background)
- `{ isDeleted: 1 }` (background)

## Schema Definition
```javascript
const TransactionSchema = {
  _id: ObjectId, // MongoDB ObjectId
  userId: { type: ObjectId, ref: 'User', required: true, index: true },
  categoryId: { type: ObjectId, ref: 'Category', required: true, index: true },

  // Financial data with precision handling
  amount: { 
    type: mongoose.Schema.Types.Decimal128, 
    required: true,
    min: 0.01,
    max: 999999999.99,
  },

  // Denormalized type field for performance optimization
  type: {
    type: String,
    enum: ['income', 'expense'],
    required: true
  },

  // Transaction details
  description: {
    type: String,
    required: true,
    trim: true,
    maxlength: 255
  },

  notes: {
    type: String,
    trim: true,
    maxlength: 1000,
    default: null
  },

  // User-specified transaction date
  transactionDate: {
    type: Date,
    required: true,
    min: new Date('1900-01-01'),
    max: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000)
  },

  // Auto-calculated performance optimization fields
  year: { type: Number, required: true, min: 1900, max: 2100 },
  month: { type: Number, required: true, min: 1, max: 12 },
  yearMonth: { type: String, required: true, match: /^\d{4}-\d{2}$/ },

  // Tag-based organization
  tags: [{
    type: String,
    trim: true,
    lowercase: true,
    maxlength: 20,
  }],

  // Soft delete fields
  isDeleted: { type: Boolean, default: false },
  deletedAt: { type: Date, default: null },

  createdAt: Date, // Auto-generated by Mongoose
  updatedAt: Date, // Auto-generated by Mongoose
};
```

## Validation Rules
- **Amount**: Must be between $0.01 and $999,999,999.99 with at most 2 decimal places.
- **Type**: Automatically synchronized with the referenced category's type.
- **Description**: Required, non-empty after trimming, max 255 characters.
- **Notes**: Optional, max 1000 characters.
- **Transaction Date**: Must be between 1900 and 1 year in the future.
- **Tags**: Max 3 tags per transaction, each max 20 characters, alphabets with hyphens only.
- **Year/Month/YearMonth**: Auto-calculated from transactionDate, cannot be manually set.

## Business Logic
- **Automatic Date Fields**: Year, month, and yearMonth are automatically calculated from transactionDate on save.
- **Category Validation**: categoryId must exist, belong to the user, and not be soft-deleted.
- **Type Synchronization**: Transaction type is automatically synchronized with the referenced category's type.
- **Tag Management**: Duplicate tags are automatically removed, empty tags filtered out, limited to 3 tags maximum.
- **Soft Delete**: Transactions can be soft-deleted with automatic deletedAt timestamp management.
- **Daily Limits**: Maximum 100 transactions per day per user to prevent spam.

## Performance Optimizations
- **Denormalized Type**: Transaction type is stored directly (not just referenced) for faster filtering.
- **Pre-calculated Date Fields**: Year, month, yearMonth fields enable efficient date-range queries.
- **Compound Indexes**: Strategic compound indexes for common query patterns.
- **Decimal128**: Precise financial calculations without floating-point errors.
- **Background Indexing**: All indexes created in background to avoid blocking operations.
- **Lean Queries**: Static methods use .lean() for better performance when possible.

## Security & Data Integrity
- **Ownership Validation**: All operations validate that categoryId belongs to the requesting user.
- **Referential Integrity**: Pre-save middleware ensures referenced categories exist and are accessible.
- **Input Sanitization**: All string fields are trimmed and validated.
- **Amount Precision**: Decimal128 prevents floating-point calculation errors.
- **Audit Trail**: Soft delete preserves data for audit purposes while hiding from normal queries.